<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Unsend Message Feature</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Test Unsend Message Feature</h1>
    
    <div class="test-section info">
        <h3>Instructions</h3>
        <p>This test will verify the unsend message functionality with both real and temporary message IDs.</p>
        <p>Make sure the backend services are running and you have a valid chat session.</p>
    </div>

    <div class="test-section">
        <h3>Configuration</h3>
        <label>API Base URL: <input type="text" id="apiUrl" value="http://localhost:8080/api/v1" style="width: 300px;"></label><br><br>
        <label>Auth Token: <input type="text" id="authToken" value="" placeholder="Enter your auth token" style="width: 500px;"></label><br><br>
        <label>Chat ID: <input type="text" id="chatId" value="" placeholder="Enter chat ID" style="width: 300px;"></label><br><br>
        <button onclick="testConnection()">Test Connection</button>
    </div>

    <div class="test-section">
        <h3>Test Cases</h3>
        <button onclick="testUnsendRealMessage()">Test 1: Unsend Real Message</button>
        <button onclick="testUnsendTempMessage()">Test 2: Unsend Temp Message</button>
        <button onclick="testUnsendNonExistentMessage()">Test 3: Unsend Non-existent Message</button>
        <button onclick="testUnsendUnauthorizedMessage()">Test 4: Unsend Unauthorized Message</button>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Test Results</h3>
        <div id="log" class="log">Test log will appear here...\n</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString();
            const prefix = type.toUpperCase();
            logElement.textContent += `[${timestamp}] ${prefix}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function makeRequest(endpoint, method = 'GET', body = null) {
            const apiUrl = document.getElementById('apiUrl').value;
            const authToken = document.getElementById('authToken').value;
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${apiUrl}${endpoint}`, options);
                const data = await response.json();
                
                log(`${method} ${endpoint} - Status: ${response.status}`);
                log(`Response: ${JSON.stringify(data, null, 2)}`);
                
                return { response, data };
            } catch (error) {
                log(`Error making request: ${error.message}`, 'error');
                return { error };
            }
        }

        async function testConnection() {
            log('Testing connection to API...');
            const result = await makeRequest('/health');
            
            if (result.error) {
                log('Connection failed!', 'error');
            } else if (result.response.ok) {
                log('Connection successful!', 'success');
            } else {
                log('Connection test returned non-200 status', 'warning');
            }
        }

        async function sendTestMessage() {
            const chatId = document.getElementById('chatId').value;
            if (!chatId) {
                log('Please enter a chat ID first', 'error');
                return null;
            }
            
            log('Sending test message...');
            const messageBody = {
                chat_id: chatId,
                content: `Test message for unsend - ${Date.now()}`,
                message_type: 'text'
            };
            
            const result = await makeRequest('/messages', 'POST', messageBody);
            
            if (result.response && result.response.ok) {
                log(`Test message sent with ID: ${result.data.message_id}`, 'success');
                return result.data.message_id;
            } else {
                log('Failed to send test message', 'error');
                return null;
            }
        }

        async function testUnsendRealMessage() {
            log('=== Test 1: Unsend Real Message ===');
            
            // First, send a message to get a real message ID
            const messageId = await sendTestMessage();
            if (!messageId) {
                log('Cannot proceed with test - failed to send message', 'error');
                return;
            }
            
            // Wait a moment for the message to be processed
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Now try to unsend it
            const chatId = document.getElementById('chatId').value;
            log(`Attempting to unsend message ${messageId}...`);
            
            const result = await makeRequest(`/messages/${messageId}?chat_id=${chatId}`, 'DELETE');
            
            if (result.response && result.response.ok) {
                log('✅ Real message unsend test PASSED', 'success');
            } else {
                log('❌ Real message unsend test FAILED', 'error');
            }
        }

        async function testUnsendTempMessage() {
            log('=== Test 2: Unsend Temp Message ===');
            
            const chatId = document.getElementById('chatId').value;
            if (!chatId) {
                log('Please enter a chat ID first', 'error');
                return;
            }
            
            // Use a temporary message ID format
            const tempMessageId = `temp_${Date.now()}`;
            log(`Attempting to unsend temp message ${tempMessageId}...`);
            
            const result = await makeRequest(`/messages/${tempMessageId}?chat_id=${chatId}`, 'DELETE');
            
            if (result.response && (result.response.status === 200 || result.response.status === 404)) {
                log('✅ Temp message unsend test PASSED (handled gracefully)', 'success');
            } else {
                log('❌ Temp message unsend test FAILED', 'error');
            }
        }

        async function testUnsendNonExistentMessage() {
            log('=== Test 3: Unsend Non-existent Message ===');
            
            const chatId = document.getElementById('chatId').value;
            if (!chatId) {
                log('Please enter a chat ID first', 'error');
                return;
            }
            
            // Use a non-existent message ID
            const fakeMessageId = 'nonexistent_message_99999';
            log(`Attempting to unsend non-existent message ${fakeMessageId}...`);
            
            const result = await makeRequest(`/messages/${fakeMessageId}?chat_id=${chatId}`, 'DELETE');
            
            if (result.response && result.response.status === 404) {
                log('✅ Non-existent message unsend test PASSED (returned 404)', 'success');
            } else {
                log('❌ Non-existent message unsend test FAILED', 'error');
            }
        }

        async function testUnsendUnauthorizedMessage() {
            log('=== Test 4: Unsend Unauthorized Message ===');
            
            const chatId = document.getElementById('chatId').value;
            if (!chatId) {
                log('Please enter a chat ID first', 'error');
                return;
            }
            
            // Try to unsend a message that belongs to another user
            // This assumes there are existing messages in the chat
            log('This test requires an existing message from another user...');
            
            // For demo purposes, we'll use a placeholder message ID
            const otherUserMessageId = 'other_user_message_123';
            log(`Attempting to unsend unauthorized message ${otherUserMessageId}...`);
            
            const result = await makeRequest(`/messages/${otherUserMessageId}?chat_id=${chatId}`, 'DELETE');
            
            if (result.response && (result.response.status === 403 || result.response.status === 404)) {
                log('✅ Unauthorized message unsend test PASSED (returned 403/404)', 'success');
            } else {
                log('❌ Unauthorized message unsend test FAILED', 'error');
            }
        }

        async function runAllTests() {
            log('=== Running All Tests ===');
            clearLog();
            
            await testUnsendRealMessage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUnsendTempMessage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUnsendNonExistentMessage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUnsendUnauthorizedMessage();
            
            log('=== All Tests Completed ===');
        }
    </script>
</body>
</html>
