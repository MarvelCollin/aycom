<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registration Validation Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f7f9fc;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .test-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 5px solid #ddd;
    }
    .success { border-left-color: #2ecc71; }
    .warning { border-left-color: #f39c12; }
    .error { border-left-color: #e74c3c; }
    .pending { border-left-color: #3498db; }
    
    .test-title {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }
    .test-result {
      font-size: 0.9em;
      white-space: pre-wrap;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow: auto;
    }
    .status-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: normal;
    }
    .badge-success { background-color: #2ecc71; color: white; }
    .badge-warning { background-color: #f39c12; color: white; }
    .badge-error { background-color: #e74c3c; color: white; }
    .badge-pending { background-color: #3498db; color: white; }
    
    .controls {
      margin: 20px 0;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #2980b9;
    }
    #summary {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Registration Validation Test</h1>
  
  <div class="controls">
    <button id="runTests">Run All Tests</button>
    <span id="progress"></span>
  </div>
  
  <div id="testResults"></div>
  
  <div id="summary"></div>
  
  <script>
    const API_URL = "http://localhost:8080/api/users/register";
    
    // Test cases with different validation errors
    const testCases = [
      {
        name: "Empty form",
        data: {
          name: "",
          username: "",
          email: "",
          password: "",
          confirm_password: "",
          gender: "",
          date_of_birth: "",
          security_question: "",
          security_answer: "",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["required", "validation"]
      },
      {
        name: "Short name",
        data: {
          name: "Abc",
          username: "validuser",
          email: "valid@example.com",
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["name", "must be at least 4 characters"]
      },
      {
        name: "Name with numbers",
        data: {
          name: "User123",
          username: "validuser",
          email: "valid@example.com",
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["name", "must not contain"]
      },
      {
        name: "Invalid email",
        data: {
          name: "Valid User",
          username: "validuser",
          email: "invalid-email",
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["email", "invalid"]
      },
      {
        name: "Weak password (missing upper)",
        data: {
          name: "Valid User",
          username: "validuser",
          email: "valid@example.com",
          password: "password123!",
          confirm_password: "password123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["uppercase"]
      },
      {
        name: "Password mismatch",
        data: {
          name: "Valid User",
          username: "validuser",
          email: "valid@example.com",
          password: "Password123!",
          confirm_password: "DifferentPass123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["match", "password"]
      },
      {
        name: "Invalid gender",
        data: {
          name: "Valid User",
          username: "validuser",
          email: "valid@example.com",
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "other",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["gender", "male", "female"]
      },
      {
        name: "User too young",
        data: {
          name: "Valid User",
          username: "validuser",
          email: "valid@example.com",
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "male",
          date_of_birth: "5-15-2020",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["13 years", "age"]
      },
      {
        name: "Short security answer",
        data: {
          name: "Valid User",
          username: "validuser",
          email: "valid@example.com",
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Ni",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: ["security answer", "at least 3"]
      },
      {
        name: "Valid registration",
        data: {
          name: "Test User",
          username: "testuser" + Math.floor(Math.random() * 10000),
          email: `test${Math.floor(Math.random() * 10000)}@example.com`,
          password: "Password123!",
          confirm_password: "Password123!",
          gender: "male",
          date_of_birth: "5-15-2000",
          security_question: "What was your childhood nickname?",
          security_answer: "Nickname",
          recaptcha_token: "dev-mode-token"
        },
        expectedErrors: null
      }
    ];
    
    // Create test results containers
    function initializeUI() {
      const resultsContainer = document.getElementById('testResults');
      resultsContainer.innerHTML = '';
      
      testCases.forEach((test, index) => {
        const testCard = document.createElement('div');
        testCard.className = 'test-card pending';
        testCard.id = `test-${index}`;
        
        const testTitle = document.createElement('div');
        testTitle.className = 'test-title';
        
        const titleText = document.createElement('span');
        titleText.textContent = `${index + 1}. ${test.name}`;
        
        const statusBadge = document.createElement('span');
        statusBadge.className = 'status-badge badge-pending';
        statusBadge.textContent = 'Pending';
        statusBadge.id = `status-${index}`;
        
        testTitle.appendChild(titleText);
        testTitle.appendChild(statusBadge);
        
        const testResult = document.createElement('div');
        testResult.className = 'test-result';
        testResult.id = `result-${index}`;
        testResult.textContent = 'Waiting to run...';
        
        testCard.appendChild(testTitle);
        testCard.appendChild(testResult);
        resultsContainer.appendChild(testCard);
      });
    }
    
    // Update a test result
    function updateTestResult(index, status, message) {
      const testCard = document.getElementById(`test-${index}`);
      const statusBadge = document.getElementById(`status-${index}`);
      const resultDiv = document.getElementById(`result-${index}`);
      
      testCard.className = `test-card ${status}`;
      statusBadge.className = `status-badge badge-${status}`;
      
      switch (status) {
        case 'success':
          statusBadge.textContent = 'PASS';
          break;
        case 'warning':
          statusBadge.textContent = 'WARNING';
          break;
        case 'error':
          statusBadge.textContent = 'FAIL';
          break;
        default:
          statusBadge.textContent = 'Pending';
      }
      
      resultDiv.textContent = message;
    }
    
    // Run a single test
    async function runTest(index) {
      const test = testCases[index];
      updateTestResult(index, 'pending', 'Running test...');
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(test.data)
        });
        
        let responseData;
        try {
          responseData = await response.json();
        } catch (e) {
          responseData = { error: "Failed to parse response" };
        }
        
        const statusMessage = `Status: ${response.status} ${response.ok ? '(OK)' : '(Error)'}`;
        
        // Testing logic based on whether we expect success or failure
        if (test.expectedErrors === null) {
          // This should be a successful registration
          if (response.ok && responseData.success) {
            updateTestResult(index, 'success', `${statusMessage}\n\nValid registration was accepted`);
            return true;
          } else {
            updateTestResult(
              index, 
              'error', 
              `${statusMessage}\n\nValid registration was rejected\n\n${JSON.stringify(responseData, null, 2)}`
            );
            return false;
          }
        } else {
          // This should be a validation error
          if (!response.ok || !responseData.success) {
            // Check if expected error messages are in the response
            const errorMessage = responseData.message || 
                                (responseData.error ? responseData.error.message : "");
            
            const hasExpectedErrors = test.expectedErrors.every(errorText => 
              errorMessage.toLowerCase().includes(errorText.toLowerCase())
            );
            
            if (hasExpectedErrors) {
              updateTestResult(
                index, 
                'success', 
                `${statusMessage}\n\nValidation error detected correctly\n\nError message: ${errorMessage}`
              );
              return true;
            } else {
              updateTestResult(
                index, 
                'warning', 
                `${statusMessage}\n\nResponse has error but not the expected validation messages\n\nExpected to find: ${test.expectedErrors.join(", ")}\n\nActual message: ${errorMessage}`
              );
              return false;
            }
          } else {
            updateTestResult(
              index, 
              'error', 
              `${statusMessage}\n\nInvalid input was incorrectly accepted\n\n${JSON.stringify(responseData, null, 2)}`
            );
            return false;
          }
        }
      } catch (error) {
        updateTestResult(
          index, 
          'error', 
          `Error running test: ${error.message}`
        );
        return false;
      }
    }
    
    // Run all tests
    async function runAllTests() {
      document.getElementById('runTests').disabled = true;
      document.getElementById('summary').textContent = "Running tests...";
      initializeUI();
      
      let passed = 0;
      for (let i = 0; i < testCases.length; i++) {
        document.getElementById('progress').textContent = `Running test ${i+1}/${testCases.length}`;
        if (await runTest(i)) {
          passed++;
        }
        // Small delay to avoid overwhelming the server
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      document.getElementById('progress').textContent = '';
      document.getElementById('summary').textContent = `Tests completed: ${passed} passed, ${testCases.length - passed} failed`;
      document.getElementById('runTests').disabled = false;
    }
    
    // Initialize UI and set up event listeners
    document.addEventListener('DOMContentLoaded', () => {
      initializeUI();
      document.getElementById('runTests').addEventListener('click', runAllTests);
    });
  </script>
</body>
</html> 